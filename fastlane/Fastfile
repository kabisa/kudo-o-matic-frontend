fastlane_require 'pry'
fastlane_require 'spaceship'
fastlane_require 'nokogiri'

before_all do
  message =  changelog_from_git_commits(commits_count: 1)

  cordova_config = Nokogiri::XML((File.read("#{current_dir}/cordova/config.xml")))
  @app_identifier = cordova_config.xpath("/*/@id").first.value
  @config_version = cordova_config.xpath("/*/@version").first.value
  @app_name = cordova_config.xpath("//xmlns:name").text
  @team_id = cordova_config.xpath("//xmlns:team_id").text

  @metadata = YAML.load_file('fastlane/metadata.yml')
  @metadata["copyright"] = @metadata["copyright"].gsub("&current_year", Time.now.year.to_s)
  @languages = get_languages(@metadata)

  @environment = "development"
  if @branch == 'appstore'
    @environment = "production"
  end
  @build_hockey = message.include?('DEPLOY_HOCKEY')
  @deploy_store = message.include?('DEPLOY_STORE')
  @release_notes = message.gsub('BUILD_HOCKEY', '')
  @branch = git_branch.gsub('origin/', '')
  Dir.chdir('..') if in_fastlane
end

lane :lane_deploy do
  p @deploy_store

  if @deploy_store
    p "Checking version"
    check_version
  end

  if @build_hockey || @deploy_store
    lane_deploy_android
    lane_deploy_ios
  end
end

lane :lane_deploy_android do
  FileUtils.rm_rf("#{current_dir}/cordova/platforms/android/build/outputs/apk/.", secure: true)
  android_version = get_android_version(@config_version)

  sh('APP_ENV=#{@environment} bin/maji build android')

  unless @deploy_store

    hockey public_identifier: ENV['FL_HOCKEY_PUBLIC_IDENTIFIER_ANDROID'],
           apk: "#{current_dir}/cordova/platforms/android/build/outputs/apk/android-debug.apk",
           create_update: true,
           bundle_version: android_version,
           bundle_short_version: @branch,
           status: '2',
           notes: @release_notes
  else
    # release procedure for play store here
    sh('APP_ENV=#{@environment} bin/maji build android --release')

    sign_apk(
      keystore_path: "#{current_dir}/fastlane/vault/android.jks",
      alias: "android-release-signed",
      storepass: ENV['ANDROID_KEY_STORE_PASSWORD'],
      tsa: "http://timestamp.comodoca.com/rfc316",
      apk_path: File.expand_path("#{current_dir}/cordova/platforms/android/build/outputs/apk/android-release-unsigned.apk", File.dirname(__FILE__))
    )

    zipalign(apk_path: "#{lane_context[SharedValues::SIGNED_APK_PATH]}")

    sh("calabash-android resign #{File.expand_path("#{current_dir}/cordova/platforms/android/build/outputs/apk/android-release-unsigned.apk", File.dirname(__FILE__))}")

    prepare_android_metadata

    fix_avd_location

    automated_test_emulator_run(
      ADB_restart: false,
      AVD_setup_path: "#{current_dir}/fastlane/AVD_setup.json",
      shell_task:"cd #{File.expand_path("fastlane/", File.dirname(__FILE__))} && SCREENSHOT_PATH=#{File.expand_path("fastlane/screenshots/android/", File.dirname(__FILE__))}/ bundler exec calabash-android run #{File.expand_path("#{current_dir}/cordova/platforms/android/build/outputs/apk/android-release-unsigned.apk", File.dirname(__FILE__))}"
    )

    # For now just copy it over to all the language directories. There's no way we can change the language of the phone from cli yet.
    FileUtils.cp_r("fastlane/screenshots/android/.", "fastlane/metadata/android/*/images/phoneScreenshots/")
    FileUtils.rm_rf("fastlane/screenshots/android/", secure: true)

    supply  track: "production",
            apk: "#{current_dir}/cordova/platforms/android/build/outputs/apk/android-release.apk",
            json_key: "#{current_dir}/fastlane/vault/ANDROID_JSON_KEY_FILE.json",
            package_name: @app_identifier,
            metadata_path: "#{current_dir}/fastlane/metadata/android/"
  end
end

lane :lane_deploy_ios do
  FileUtils.rm_rf("#{current_dir}/cordova/platforms/ios/build/device/.", secure: true)
  FileUtils.rm_rf("tmp/output/#{@app_name}.result/", secure: true)

  # where the signed ipa is placed
  output_dir = File.join(Dir.pwd, "tmp/output")
  setup_jenkins(output_directory: output_dir)

  #Download the profile from apple so we can obtain the profile_uuid of the provisioning profile
  FileUtils.rm_rf("profiles/", secure: true)
  FileUtils.mkdir_p("profiles")

  sh("fastlane sigh --provisioning_name=\"match AdHoc #{@app_identifier}\" --username=\"info@kabisa.nl\" --app_identifier=\"#{@app_identifier}\" --skip_install --adhoc --ignore_profiles_with_different_name --output_path=\"./profiles\"")
  sh("security cms -D -i ./profiles/AdHoc_#{@app_identifier}.mobileprovision > ./profiles/AdHoc_#{@app_identifier}.plist || true")
  profile_uuid = sh("/usr/libexec/PlistBuddy -c \"Print :UUID\" ./profiles/AdHoc_#{@app_identifier}.plist").chomp
  FileUtils.rm_rf("profiles/", secure: true)

  #Build the app for ios
  sh("APP_ENV=#{@environment} bin/maji build ios -- --codeSignIdentity=\"iPhone Distribution: Kabisa BV (#{@team_id})\" --developmentTeam=\"#{@team_id}\" --packageType=\"adHoc\" --provisioningProfile=\"#{profile_uuid}\"")

  match username: 'info@kabisa.nl',
        git_url: 'git@github.com:kabisa/match-certificates.git',
        type: 'adhoc',
        app_identifier: @app_identifier,
        force_for_new_devices: :true

  #Make sure automatic code signing is disabled, we dont want this.
  disable_automatic_code_signing(
    path: "#{current_dir}/cordova/platforms/ios/#{@app_name}.xcodeproj",
    team_id: @team_id
  )

  #Make sure the correct provisioning profiles are setup based on the earlier obtained profile_uuid
  update_project_provisioning(
    xcodeproj: "#{current_dir}/cordova/platforms/ios/#{@app_name}.xcodeproj",
    profile: "/Users/jenkins/Library/MobileDevice/Provisioning\ Profiles/#{profile_uuid}.mobileprovision",
    build_configuration: "Release"
  )

  upgrade_super_old_xcode_project(
    path: "#{current_dir}/cordova/platforms/ios/#{@app_name}.xcodeproj",
    team_id: @team_id
  )

  # opening xcode prevents timeout
  sh("open -a xcode #{current_dir}/cordova/platforms/ios/#{@app_name}.xcodeproj")

  gym scheme: @app_name,
      project: "#{current_dir}/cordova/platforms/ios/#{@app_name}.xcodeproj",
      export_method: "ad-hoc"


  unless @deploy_store
    hockey public_identifier: ENV['FL_HOCKEY_PUBLIC_IDENTIFIER_IOS'],
           ipa: File.join(output_dir, "#{@app_name}.ipa"),
           create_update: true,
           bundle_version: @config_version,
           bundle_short_version: @branch,
           status: '2',
           notes: @release_notes

  else
    # release procedure for appstore here
    # Make sure old screenshots are removed
    FileUtils.rm_rf("fastlane/screenshots/*", secure: true)

    #generate new screenshots
    snapshot  project: "#{current_dir}/cordova/platforms/ios/#{@app_name}.xcodeproj",
              output_directory: "#{current_dir}/fastlane/screenshots/",
              scheme: @app_name,
              skip_helper_version_check: true


    deliver ipa: "#{output_dir}/#{@app_name}.ipa",
            submit_for_review: true,
            force: true,
            username: "info@kabisa.nl",
            overwrite_screenshots: true,
            metadata_path: "#{current_dir}/fastlane/metadata/",
            screenshots_path: "#{current_dir}/fastlane/screenshots/",
            app_icon: "#{current_dir}/src/assets/logo/AppStore-1024.png"

  end

end

def check_version
  Spaceship::Tunes.login("info@kabisa.nl", ENV['FASTLANE_PASSWORD'])
  app = Spaceship::Tunes::Application.find(@app_identifier)
  apple_version = app.build_trains.keys.last

  if Gem::Version.new(@config_version) <= Gem::Version.new(apple_version)
    raise 'The version is your Cordova config is NOT higher than the version in iTunes Connect. Please increment your version. The iTunes Connect version is: ' + apple_version
  end

end

def get_android_version (config_version)
  version_splitted = config_version.split "."
  version_splitted[0] + version_splitted[1].rjust(2, '0') + version_splitted[2].rjust(2, '0')
end

def fix_avd_location
  json_file = "#{current_dir}/fastlane/AVD_setup.json"

  json = JSON.parse(File.read(json_file))

  json["avd_list"].each do |avd|
    avd["create_avd_hardware_config_filepath"] = File.expand_path(avd["create_avd_hardware_config_filepath"])
  end

  File.write(json_file, JSON.pretty_generate(json))
end

def get_languages(metadata)
  result = []
  metadata["languages"].each do |key, _|
    result.push(key)
  end
  result
end

def prepare_android_metadata

  FileUtils.rm_rf("fastlane/metadata/", secure: true)
  FileUtils.mkdir_p("fastlane/metadata/android")
  FileUtils.rm_rf("fastlane/screenshots/*", secure: true)
  FileUtils.mkdir_p("fastlane/screenshots/android/")

  @languages.each {|lang|
    FileUtils.mkdir_p("fastlane/metadata/android/#{lang}/images")
    FileUtils.mkdir_p("fastlane/metadata/android/#{lang}/images/phoneScreenshots")
    FileUtils.mkdir_p("fastlane/metadata/android/#{lang}/images/sevenInchScreenshots")
    FileUtils.mkdir_p("fastlane/metadata/android/#{lang}/images/tenInchScreenshots")
    FileUtils.mkdir_p("fastlane/metadata/android/#{lang}/images/tvScreenshots")
    FileUtils.mkdir_p("fastlane/metadata/android/#{lang}/images/wearScreenshots")
    FileUtils.touch("fastlane/metadata/android/#{lang}/video.txt")

    language_metadata = @metadata["languages"][lang]
    File.write("fastlane/metadata/android/#{lang}/title.txt", language_metadata["name"])
    File.write("fastlane/metadata/android/#{lang}/short_description.txt", language_metadata["short_description"])
    File.write("fastlane/metadata/android/#{lang}/full_description.txt", language_metadata["description"])

    File.write("fastlane/metadata/android/#{lang}/images/icon.png", @metadata["android_app_icon"])
    File.write("fastlane/metadata/android/#{lang}/images/featureGraphic.png", @metadata["feature_graphic"])
    File.write("fastlane/metadata/android/#{lang}/images/promoGraphicpng", @metadata["promo_graphic"])
  }

end

def current_dir
  File.basename(Dir.getwd)
end

def in_fastlane
  current_dir == 'fastlane'
end
