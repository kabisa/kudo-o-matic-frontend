pipeline {
    agent {
       label 'kabisas-mac-mini'
    }

    environment {
        PATH = '/usr/local/bin:/usr/local/sbin:/usr/bin:/bin:/usr/sbin:/sbin:/usr/local/rvm/bin/:/Users/jenkins/Library/Android/sdk/platform-tools:/Users/jenkins/Library/Android/sdk/tools'
        LC_ALL = 'en_US.UTF-8'
        MATCH_PASSWORD = credentials('MATCH_PASSWORD')
        FL_HOCKEY_API_TOKEN = credentials('FL_HOCKEY_API_TOKEN')
        FL_HOCKEY_PUBLIC_IDENTIFIER_ANDROID = credentials('FL_HOCKEY_PUBLIC_IDENTIFIER_ANDROID')
        FL_HOCKEY_PUBLIC_IDENTIFIER_IOS = credentials('FL_HOCKEY_PUBLIC_IDENTIFIER_IOS')
        FASTLANE_PASSWORD = credentials('FASTLANE_PASSWORD')
        FASTLANE_XCODEBUILD_SETTINGS_TIMEOUT = 120
    }

    stages {

        stage("Deploy hockey") {
            when {
                 anyOf {
                    branch 'demo';branch 'appstore';
                 }
            }
            steps {
                sh '''#!/bin/bash -l
                rvm install $(cat .ruby-version)
                rvm use $(cat .ruby-version)
                ruby -v
                bundle install
                yarn install

                /usr/local/bin/prepare-keychain-for-codesign

                eval $(ssh-agent -s)
                ssh-add /Users/jenkins/.ssh/id_rsa

                bundle exec fastlane deploy
                '''
            }
        }

    }

}
