pipeline {
    agent {
       label 'kabisas-mac-mini'
    }

    environment {
        PATH = '/usr/local/bin:/usr/local/sbin:/usr/bin:/bin:/usr/sbin:/sbin:/usr/local/rvm/bin/:/Users/jenkins/Library/Android/sdk/platform-tools:/Users/jenkins/Library/Android/sdk/tools:/Users/jenkins/Library/Android/sdk/build-tools/26.0.1:/Users/jenkins/Library/Android/sdk/platform-tools:'
        LC_ALL = 'en_US.UTF-8'
        MATCH_PASSWORD = credentials('MATCH_PASSWORD')
        FL_HOCKEY_API_TOKEN = credentials('FL_HOCKEY_API_TOKEN')
        FL_HOCKEY_PUBLIC_IDENTIFIER_ANDROID = credentials('FL_HOCKEY_PUBLIC_IDENTIFIER_ANDROID')
        FL_HOCKEY_PUBLIC_IDENTIFIER_IOS = credentials('FL_HOCKEY_PUBLIC_IDENTIFIER_IOS')
        FASTLANE_PASSWORD = credentials('FASTLANE_PASSWORD')
        FASTLANE_XCODEBUILD_SETTINGS_TIMEOUT = 120
        GOOGLE_JSON_KEY_FILE = credentials('GOOGLE_JSON_KEY_FILE')
        ANDROID_KEY_STORE = credentials('ANDROID_KEY_STORE')
    }

    stages {

        stage("Deploy hockey") {
            when {
                 anyOf {
                    branch 'demo';branch 'appstore';
                 }
            }
            steps {
                script {
                  currUser = sh(returnStdout: true, script: 'whoami')
                  env.ANDROID_SDK_ROOT = '/Users/${currUser}/Library/Android/sdk/'
                  env.ANDROID_HOME = '/Users/${currUser}/Library/Android/sdk/'
                }

                sh '''#!/bin/bash -l
                rvm install $(cat .ruby-version)
                rvm use $(cat .ruby-version)
                ruby -v
                bundle install
                yarn install

                /usr/local/bin/prepare-keychain-for-codesign

                mkdir -p fastlane/vault/
                cat $GOOGLE_JSON_KEY_FILE > fastlane/vault/GOOGLE_JSON_KEY_FILE.json
                cat $ANDROID_KEY_STORE > fastlane/vault/android.jks

                eval $(ssh-agent -s)
                ssh-add /Users/jenkins/.ssh/id_rsa

                bundle exec fastlane deploy
                '''
            }
        }

    }

}
